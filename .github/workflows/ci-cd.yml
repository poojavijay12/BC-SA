name: CI/CD - build & deploy to GCE VM

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud (Workload Identity)
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: "${{ secrets.WIF_PROVIDER_FULL }}"
        service_account: "${{ secrets.GCP_SA_EMAIL }}"
        create_credentials_file: true
        export_environment_variables: true
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v3
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        version: "latest"

    - name: Fetch SSH key from Secret Manager (via gcloud)
      id: get-ssh
      run: |
        # Clean up any previous files
        rm -f ./deploy_key ./deploy_key.b64

        # Fetch raw secret (should be base64-encoded private key)
        echo "Fetching SSH key from Secret Manager..."
        gcloud secrets versions access latest --secret="github-actions-ssh-key" --project="${{ secrets.GCP_PROJECT_ID }}" \
          | tr -d '\r' > ./deploy_key.b64

        # Fail quickly if secret is empty
        if [ ! -s ./deploy_key.b64 ]; then
          echo "ERROR: fetched secret is empty" >&2
          ls -l ./deploy_key.b64 || true
          exit 1
        fi

        # Decode into actual private key file
        base64 --decode ./deploy_key.b64 > ./deploy_key
        chmod 600 ./deploy_key

        # Debug (non-secret): show size and header line
        echo "deploy_key size (bytes): $(wc -c < ./deploy_key)"
        head -n 1 ./deploy_key | sed -n '1p'

    - name: Build Docker image
      env:
        GCP_REGION: ${{ secrets.GCP_REGION }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        ARTIFACT_REPO: ${{ secrets.ARTIFACT_REPO }}
        IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
      run: |
        IMAGE="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REPO}/${IMAGE_NAME}:${GITHUB_SHA::8}"
        echo "Building image: $IMAGE"
        docker build -t "$IMAGE" .
        # authenticate docker to Artifact Registry using gcloud credentials file created by auth action
        gcloud auth configure-docker "${GCP_REGION}-docker.pkg.dev" --quiet
        docker push "$IMAGE"
        echo "IMAGE=$IMAGE" >> $GITHUB_ENV

    - name: Deploy to VM (inline commands, safer)
      env:
        VM_IP: ${{ secrets.VM_EXTERNAL_IP }}
        VM_USER: ${{ secrets.VM_USER }}
      run: |
        # Verify inputs
        if [ -z "${VM_IP:-}" ]; then
          echo "ERROR: VM_EXTERNAL_IP is empty. Add secret VM_EXTERNAL_IP to the repo." >&2
          exit 1
        fi
        if [ -z "${VM_USER:-}" ]; then
          echo "ERROR: VM_USER is empty. Add secret VM_USER to the repo." >&2
          exit 1
        fi
        if [ ! -s ./deploy_key ]; then
          echo "ERROR: deploy_key file missing or empty. Check Secret Manager step wrote ./deploy_key" >&2
          ls -l ./deploy_key || true
          exit 1
        fi

        # Non-sensitive debug
        echo "Deploying image: ${IMAGE:-<missing IMAGE var>} to ${VM_IP} as ${VM_USER}"
        echo "deploy_key size (bytes): $(wc -c < ./deploy_key)"

        # quick ssh test (short timeout)
        ssh -o BatchMode=yes -o ConnectTimeout=10 -i ./deploy_key "${VM_USER}@${VM_IP}" "echo SSH_OK" || {
          echo "ERROR: SSH test failed. Check that deploy_key is valid, public key is on VM, VM_USER/VM_IP are correct, and firewall allows port 22." >&2
          exit 1
        }

        # actual deploy - pull image, stop old container, run new one
        ssh -o StrictHostKeyChecking=no -i ./deploy_key "${VM_USER}@${VM_IP}" \
          "docker pull ${IMAGE} && docker rm -f python-backend || true && docker run -d --name python-backend -p 8000:8000 --restart unless-stopped ${IMAGE}"
