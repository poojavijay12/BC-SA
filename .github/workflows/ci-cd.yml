name: CI/CD

on:
  push:
    branches: [ main ]

permissions:
  id-token: write    # required for OIDC
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # Authenticate to GCP via Workload Identity Federation
    - name: Authenticate to Google Cloud
      uses: 'google-github-actions/auth@v1'
      with:
        workload_identity_provider: "projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ secrets.WIF_POOL }}/providers/${{ secrets.WIF_PROVIDER }}"
        service_account: "${{ secrets.GCP_SA_EMAIL }}"

    - name: Setup gcloud CLI
      uses: 'google-github-actions/setup-gcloud@v3'
      with:
        version: '>= 363.0.0'
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Get secrets from Secret Manager
      id: get-secrets
      uses: 'google-github-actions/get-secretmanager-secrets@v0'
      with:
        secrets: |
          github-actions-ssh-key:SSH_KEY
          db-password:DB_PASSWORD
          # add other secrets as needed
      # outputs are available as steps.get-secrets.outputs.SSH_KEY etc. (Base64)
      
    - name: Decode SSH key to file
      run: |
        echo "${{ steps.get-secrets.outputs.SSH_KEY }}" | base64 --decode > ./deploy_key
        chmod 600 ./deploy_key

    - name: Build Docker image
      run: |
        IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO }}/${{ secrets.IMAGE_NAME }}:${GITHUB_SHA::8}"
        docker build -t "$IMAGE" .
        # Configure docker to use Artifact Registry via gcloud
        gcloud auth configure-docker "${{ secrets.GCP_REGION }}-docker.pkg.dev" --quiet
        docker push "$IMAGE"
      env:
        GCP_REGION: ${{ secrets.GCP_REGION }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        ARTIFACT_REPO: ${{ secrets.ARTIFACT_REPO }}
        IMAGE_NAME: ${{ secrets.IMAGE_NAME }}

    - name: Deploy to VM via SSH (pull & restart)
      run: |
        IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO }}/${{ secrets.IMAGE_NAME }}:${GITHUB_SHA::8}"
        # copy a deploy helper to the VM and run it (alternatively run commands inline)
        scp -o StrictHostKeyChecking=no -i ./deploy_key ./deploy/scripts/restart_container.sh ubuntu@${{ secrets.VM_EXTERNAL_IP }}:/tmp/restart_container.sh
        ssh -o StrictHostKeyChecking=no -i ./deploy_key ubuntu@${{ secrets.VM_EXTERNAL_IP }} "bash /tmp/restart_container.sh $IMAGE ${{ secrets.DB_PASSWORD }}"
      env:
        GCP_REGION: ${{ secrets.GCP_REGION }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        ARTIFACT_REPO: ${{ secrets.ARTIFACT_REPO }}
        IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
