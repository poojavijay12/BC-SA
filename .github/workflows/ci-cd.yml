name: CI/CD - build & deploy to GCE VM

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud (Workload Identity)
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: "${{ secrets.WIF_PROVIDER_FULL }}"
        service_account: "${{ secrets.GCP_SA_EMAIL }}"
        create_credentials_file: true
        export_environment_variables: true
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v3
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        version: "latest"

    - name: Fetch SSH key from Secret Manager (via gcloud)
      id: get-ssh
      run: |
        rm -f ./deploy_key ./deploy_key.b64

        echo "Fetching SSH key from Secret Manager..."
        gcloud secrets versions access latest --secret="github-actions-ssh-key" --project="${{ secrets.GCP_PROJECT_ID }}" \
          | tr -d '\r' > ./deploy_key.b64

        if [ ! -s ./deploy_key.b64 ]; then
          echo "ERROR: fetched secret is empty" >&2
          ls -l ./deploy_key.b64 || true
          exit 1
        fi

        base64 --decode ./deploy_key.b64 > ./deploy_key
        chmod 600 ./deploy_key

        echo "deploy_key size (bytes): $(wc -c < ./deploy_key)"
        head -n 1 ./deploy_key | sed -n '1p'

    - name: Build Docker image
      env:
        GCP_REGION: ${{ secrets.GCP_REGION }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        ARTIFACT_REPO: ${{ secrets.ARTIFACT_REPO }}
        IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
      run: |
        IMAGE="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REPO}/${IMAGE_NAME}:${GITHUB_SHA::8}"
        echo "Building image: $IMAGE"
        docker build -t "$IMAGE" .
        gcloud auth configure-docker "${GCP_REGION}-docker.pkg.dev" --quiet
        docker push "$IMAGE"
        echo "IMAGE=$IMAGE" >> $GITHUB_ENV

    - name: Deploy to VM (login with short-lived token & deploy)
      env:
        VM_IP: ${{ secrets.VM_EXTERNAL_IP }}
        VM_USER: ${{ secrets.VM_USER }}
        GCP_REGION: ${{ secrets.GCP_REGION }}
      run: |
        if [ -z "${VM_IP:-}" ] || [ -z "${VM_USER:-}" ]; then
          echo "ERROR: VM_EXTERNAL_IP or VM_USER is empty" >&2
          exit 1
        fi

        echo "Deploying image: ${IMAGE:-<missing IMAGE var>} to ${VM_IP} as ${VM_USER}"

        # get short-lived access token on the runner
        ACCESS_TOKEN="$(gcloud auth print-access-token)"
        if [ -z "$ACCESS_TOKEN" ]; then
          echo "ERROR: failed to get access token" >&2
          exit 1
        fi

        # ensure known host present
        mkdir -p ~/.ssh; chmod 700 ~/.ssh
        ssh-keyscan -T 10 "${VM_IP}" 2>/dev/null | tee -a ~/.ssh/known_hosts >/dev/null || true

        # run docker login on the VM and deploy the image
        ssh -o StrictHostKeyChecking=no -i ./deploy_key "${VM_USER}@${VM_IP}" /bin/bash -s <<'EOF'
set -euo pipefail
ACCESS_TOKEN_FROM_RUNNER='$ACCESS_TOKEN'
REGION='${{ secrets.GCP_REGION }}'
IMAGE='${IMAGE}'
# login to Artifact Registry on the VM using token
printf '%s' "${ACCESS_TOKEN_FROM_RUNNER}" | docker login -u oauth2accesstoken --password-stdin "https://${REGION}-docker.pkg.dev"
# pull & restart
docker pull "${IMAGE}"
docker rm -f python-backend || true
docker run -d --name python-backend -p 8000:8000 --restart unless-stopped "${IMAGE}"
EOF
