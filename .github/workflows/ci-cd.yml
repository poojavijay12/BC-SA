name: CI/CD - build & deploy to GCE VM

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud (Workload Identity)
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: "${{ secrets.WIF_PROVIDER_FULL }}"
        service_account: "${{ secrets.GCP_SA_EMAIL }}"
        create_credentials_file: true
        export_environment_variables: true
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v3
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        version: "latest"

    - name: Fetch SSH key from Secret Manager
      id: get-ssh
      uses: google-github-actions/get-secretmanager-secrets@v0
      with:
        # Format: <SECRET_NAME_IN_GCP_SECRET_MANAGER>:<OUTPUT_ENV_VAR_NAME>
        secrets: |
          github-actions-ssh-key:SSH_KEY

    - name: Write SSH key to file
      run: |
        # The secret should be base64-encoded in Secret Manager; decode and write to file
        echo "${{ steps.get-ssh.outputs.SSH_KEY }}" | base64 --decode > ./deploy_key
        chmod 600 ./deploy_key

    - name: Build Docker image
      env:
        GCP_REGION: ${{ secrets.GCP_REGION }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        ARTIFACT_REPO: ${{ secrets.ARTIFACT_REPO }}
        IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
      run: |
        IMAGE="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REPO}/${IMAGE_NAME}:${GITHUB_SHA::8}"
        docker build -t "$IMAGE" .
        # authenticate docker to Artifact Registry using gcloud credentials file created by auth action
        gcloud auth configure-docker "${GCP_REGION}-docker.pkg.dev" --quiet
        docker push "$IMAGE"
        echo "IMAGE=$IMAGE" >> $GITHUB_ENV

    - name: Deploy to VM (inline commands)
      env:
        VM_IP: ${{ secrets.VM_EXTERNAL_IP }}
        VM_USER: ${{ secrets.VM_USER }}
      run: |
        # IMAGE variable is loaded from $GITHUB_ENV set earlier
        echo "Deploying image: $IMAGE to $VM_IP as ${VM_USER}"
        ssh -o StrictHostKeyChecking=no -i ./deploy_key ${VM_USER}@${VM_IP} \
          "docker pull ${IMAGE} && docker rm -f python-backend || true && docker run -d --name python-backend -p 8000:8000 --restart unless-stopped ${IMAGE}"
